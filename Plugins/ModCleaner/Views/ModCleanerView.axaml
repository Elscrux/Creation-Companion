<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:mod="clr-namespace:CreationEditor.Avalonia.Views.Mod;assembly=CreationEditor.Avalonia"
             xmlns:avaloniaProgressRing="clr-namespace:AvaloniaProgressRing;assembly=AvaloniaProgressRing"
             xmlns:viewModels="clr-namespace:ModCleaner.ViewModels"
             xmlns:converter="clr-namespace:CreationEditor.Avalonia.Converter;assembly=CreationEditor.Avalonia"
             xmlns:system="clr-namespace:System;assembly=System.Runtime"
             xmlns:dataSource="clr-namespace:CreationEditor.Avalonia.Views.DataSource;assembly=CreationEditor.Avalonia"
             xmlns:basic="clr-namespace:CreationEditor.Avalonia.Views.Basic;assembly=CreationEditor.Avalonia"
             xmlns:controls="clr-namespace:FluentAvalonia.UI.Controls;assembly=FluentAvalonia"
             xmlns:converter1="clr-namespace:ModCleaner.Resources.Converter"
             xmlns:skyrim="clr-namespace:Mutagen.Bethesda.Skyrim;assembly=Mutagen.Bethesda.Skyrim"
             xmlns:records="clr-namespace:Mutagen.Bethesda.Plugins.Records;assembly=Mutagen.Bethesda.Core"
             xmlns:models="clr-namespace:ModCleaner.Models"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:Class="ModCleaner.Views.ModCleanerView"
             x:Name="Control"
             x:DataType="viewModels:ModCleanerVM">
    <Grid>
        <ScrollViewer IsEnabled="{Binding !IsBusy}">
            <ScrollViewer.Resources>
                <converter:ReturnParameterIfTrueConverter
                    x:Key="IfTrueConverter"
                    x:TypeArguments="system:Double"
                    DefaultValue="5"/>
            </ScrollViewer.Resources>
            <ScrollViewer.Effect>
                <BlurEffect
                    Radius="{Binding !IsBusy,
                                                 Converter={StaticResource IfTrueConverter},
                                                 ConverterParameter=0}"/>
            </ScrollViewer.Effect>

            <StackPanel Spacing="10" Margin="5">
                <StackPanel.Resources>
                    <converter1:LinkIdentifierEnricher
                        x:Key="LinkIdentifierEnricher"
                        LinkCache="{Binding EditorEnvironment.LinkCacheChanged^}"/>

                    <converter1:GetIncomingEdgesConverter
                        x:Key="GetIncomingEdgesConverter"
                        Graph="{Binding DependencyGraph}"/>

                    <DataTemplate
                        x:Key="LinkDataTemplate"
                        DataType="models:ILinkIdentifier">
                        <StackPanel Orientation="Horizontal">
                            <Button Content="?">
                                <Button.Flyout>
                                    <Flyout>
                                        <ListBox
                                            ItemsSource="{Binding Converter={StaticResource GetIncomingEdgesConverter}}"
                                            ItemTemplate="{StaticResource LinkDataTemplate}"/>
                                    </Flyout>
                                </Button.Flyout>
                            </Button>

                            <TextBlock
                                Text="{Binding Converter={StaticResource LinkIdentifierEnricher}}"
                                VerticalAlignment="Center"/>
                        </StackPanel>
                    </DataTemplate>

                    <DataTemplate
                        x:Key="LinkSearchDataTemplate"
                        DataType="models:ILinkIdentifier">
                        <StackPanel Orientation="Horizontal"
                                    Spacing="5">
                            <Button
                                Content="Search"
                                Command="{Binding #Control.ViewModel.SetLinks}">
                                <Button.CommandParameter>
                                    <MultiBinding>
                                        <Binding/>
                                        <Binding Path="$parent[ListBox].DataContext"/>
                                    </MultiBinding>
                                </Button.CommandParameter>
                            </Button>

                            <Button Content="?">
                                <Button.Flyout>
                                    <Flyout>
                                        <ListBox
                                            ItemsSource="{Binding Converter={StaticResource GetIncomingEdgesConverter}}"
                                            ItemTemplate="{StaticResource LinkDataTemplate}"/>
                                    </Flyout>
                                </Button.Flyout>
                            </Button>

                            <TextBlock
                                Text="{Binding Converter={StaticResource LinkIdentifierEnricher}}"
                                VerticalAlignment="Center"/>
                        </StackPanel>
                    </DataTemplate>
                </StackPanel.Resources>

                <basic:LabeledContentControl Header="Select Data Source to Clean">
                    <dataSource:DataSourcePicker
                        DataContext="{Binding CleaningDataSourcePicker}"/>
                </basic:LabeledContentControl>

                <basic:LabeledContentControl Header="Select Mod to Clean">
                    <mod:ModPicker
                        DataContext="{Binding CleaningModPickerVM}"
                        MaxHeight="500"/>
                </basic:LabeledContentControl>

                <basic:LabeledContentControl
                    Header="Select dependent mods that should be considered in the cleaning process - usually that should be all mods listed here"
                    IsVisible="{Binding !!DependenciesModPickerVM.Mods.Count}">
                    <mod:ModPicker
                        DataContext="{Binding DependenciesModPickerVM}"
                        MaxHeight="500"/>
                </basic:LabeledContentControl>

                <StackPanel>
                    <avaloniaProgressRing:ProgressRing
                        ToolTip.Tip="Loading References"
                        HorizontalAlignment="Left"
                        IsVisible="{Binding ReferenceService.IsLoading^}"
                        Foreground="{DynamicResource SystemAccentColor}"
                        Width="20" Height="20"/>

                    <Button
                        Content="Build Reference Graph"
                        Command="{Binding Run}"
                        IsVisible="{Binding !ReferenceService.IsLoading^}"
                        IsEnabled="{Binding CanRun^}"/>
                </StackPanel>

                <StackPanel IsVisible="{Binding !!ReferenceGraph}">
                    <TextBlock
                        Text="{Binding ReferenceGraph.Vertices.Count, StringFormat='{}Built reference graph with {0} nodes'}"/>
                    <Button Content="Build Retained Records"
                            Command="{Binding BuildRetainedLinks}"/>
                </StackPanel>

                <StackPanel IsVisible="{Binding !!DependencyGraph}">
                    <StackPanel Orientation="Horizontal">
                        <HeaderedContentControl Header="Source">
                            <controls:FAComboBox
                                x:Name="Source"
                                IsEditable="True"
                                IsTextSearchEnabled="True"
                                ItemsSource="{Binding RetainedRecords}"
                                SelectedItem="{Binding SourceLink}">
                                <controls:FAComboBox.DisplayMemberBinding>
                                    <MultiBinding StringFormat="{}{0} ({1})">
                                        <Binding Path="EditorID"/>
                                        <Binding Path="FormKey"/>
                                    </MultiBinding>
                                </controls:FAComboBox.DisplayMemberBinding>
                            </controls:FAComboBox>
                        </HeaderedContentControl>

                        <Button Content="?"
                                VerticalAlignment="Bottom">
                            <Button.Flyout>
                                <Flyout>
                                    <ListBox
                                        ItemsSource="{Binding #Source.SelectedItem, Converter={StaticResource GetIncomingEdgesConverter}}"
                                        ItemTemplate="{StaticResource LinkDataTemplate}"/>
                                </Flyout>
                            </Button.Flyout>
                        </Button>

                        <HeaderedContentControl Header="Target">
                            <controls:FAComboBox
                                x:Name="Target"
                                IsEditable="True"
                                IsTextSearchEnabled="True"
                                ItemsSource="{Binding RetainedRecords}"
                                SelectedItem="{Binding TargetLink}">
                                <controls:FAComboBox.DisplayMemberBinding>
                                    <MultiBinding StringFormat="{}{0} {1}">
                                        <Binding Path="EditorID"/>
                                        <Binding Path="FormKey"/>
                                    </MultiBinding>
                                </controls:FAComboBox.DisplayMemberBinding>
                            </controls:FAComboBox>
                        </HeaderedContentControl>

                        <Button Content="?"
                                VerticalAlignment="Bottom">
                            <Button.Flyout>
                                <Flyout>
                                    <ListBox
                                        ItemsSource="{Binding #Target.SelectedItem, Converter={StaticResource GetIncomingEdgesConverter}}"
                                        ItemTemplate="{StaticResource LinkDataTemplate}"/>
                                </Flyout>
                            </Button.Flyout>
                        </Button>
                    </StackPanel>

                    <Button Content="Find Path"
                            Command="{Binding FindPath}">
                        <Button.CommandParameter>
                            <MultiBinding>
                                <Binding Path="#Source.SelectedItem"/>
                                <Binding Path="#Target.SelectedItem"/>
                            </MultiBinding>
                        </Button.CommandParameter>
                    </Button>

                    <ListBox
                        ItemsSource="{Binding Path}"
                        ItemTemplate="{StaticResource LinkDataTemplate}"/>
                    
                    <TextBlock
                        Text="No Path Found"
                        Foreground="IndianRed"
                        IsVisible="{Binding !Path.Count}"
                        />

                    <TextBlock
                        Classes="h1"
                        Foreground="IndianRed"
                        Text="Warnings"/>

                    <DataGrid
                        IsVisible="{Binding !!InvalidExteriorCells}"
                        Background="{DynamicResource SystemControlTransparentBrush}"
                        ItemsSource="{Binding InvalidExteriorCells}"
                        CanUserSortColumns="True"
                        CanUserReorderColumns="True" CanUserResizeColumns="True"
                        AutoGenerateColumns="False"
                        IsReadOnly="True">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="FormKey"
                                                Binding="{Binding Cell.FormKey}"
                                                IsReadOnly="True"
                                                x:DataType="viewModels:ExteriorCell"/>
                            <DataGridTextColumn Header="EditorID"
                                                Binding="{Binding Cell.EditorID}"
                                                IsReadOnly="True"
                                                x:DataType="viewModels:ExteriorCell"/>
                            <DataGridTextColumn Header="Worldspace"
                                                Binding="{Binding Worldspace.EditorID}"
                                                IsReadOnly="True"
                                                x:DataType="viewModels:ExteriorCell"/>
                            <DataGridTemplateColumn>
                                <DataTemplate DataType="viewModels:ExteriorCell">
                                    <Button Content="Linked from">
                                        <Button.Flyout>
                                            <Flyout>
                                                <ListBox
                                                    ItemsSource="{Binding Cell, Converter={StaticResource GetIncomingEdgesConverter}}"
                                                    ItemTemplate="{StaticResource LinkSearchDataTemplate}"/>
                                            </Flyout>
                                        </Button.Flyout>
                                    </Button>
                                </DataTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>

                    <DataGrid
                        IsVisible="{Binding !!InvalidQuests}"
                        Background="{DynamicResource SystemControlTransparentBrush}"
                        ItemsSource="{Binding InvalidQuests}"
                        CanUserSortColumns="True"
                        CanUserReorderColumns="True" CanUserResizeColumns="True"
                        AutoGenerateColumns="False"
                        IsReadOnly="True">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="FormKey"
                                                Binding="{Binding FormKey}"
                                                IsReadOnly="True"
                                                x:DataType="skyrim:IQuestGetter"/>
                            <DataGridTextColumn Header="EditorID"
                                                Binding="{Binding EditorID}"
                                                IsReadOnly="True"
                                                x:DataType="skyrim:IQuestGetter"/>
                            <DataGridTextColumn Header="Name"
                                                Binding="{Binding Name.String}"
                                                IsReadOnly="True"
                                                x:DataType="skyrim:IQuestGetter"/>
                            <DataGridTemplateColumn Header="Path">
                                <DataTemplate DataType="skyrim:IQuestGetter">
                                    <Button Content="Linked from">
                                        <Button.Flyout>
                                            <Flyout ShowMode="Transient">
                                                <ListBox
                                                    ItemsSource="{Binding Converter={StaticResource GetIncomingEdgesConverter}}"
                                                    ItemTemplate="{StaticResource LinkSearchDataTemplate}"/>
                                            </Flyout>
                                        </Button.Flyout>
                                    </Button>
                                </DataTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>

                <Button Content="Clean Mod"
                        Command="{Binding CleanMod}"/>
                </StackPanel>
            </StackPanel>
        </ScrollViewer>

        <avaloniaProgressRing:ProgressRing
            IsActive="{Binding IsBusy}"
            HorizontalAlignment="Center" VerticalAlignment="Center"
            Width="100" Height="100"/>
    </Grid>
</UserControl>